---
layout:     post
title:      mysql底层存储
subtitle:   持续更新中
date:       2019-06-18
author:     lc
header-img: img/post-bg-universe.jpg
catalog:    true
tags:
    - mysql

---

## mysql底层存储逻辑
### 前言
mysql是互联网行业数据存储最重要的载体。平时工作中我基本只关注写sql，优化索引提升查询速度等，很少会关心mysql底层数据如何存储，最近看了本书，对于mysql讲的比较细致，这篇文章主要是大概记录mysql的数据存储结构，遇到问题能知道为什么，从而针对性的解决，太底层的细节不会讲解，如果忘了就再把[文章](https://juejin.im/book/5bffcbc9f265da614b11b731/section/5bffdb30518825773a2ed38c)读一遍，加深印象。

### 存储及查找

![](https://github.com/skyWalkerLong/skywalkerlong.github.io/blob/master/img/2019061802.png?raw=true)
看上面这张图：
- mysql的数据存在数据页里，数据页默认空间为16kB，每个数据页通过双向链表连接；
- mysql具体存储在数据页的User Records中，以二进制的形式存储，该区间存放了多条数据；
- 可以看到数据页分为多个区间。

**下面这张图是一个数据页的细节图，总结如下：**
![](https://github.com/skyWalkerLong/skywalkerlong.github.io/blob/master/img/2019061801.png?raw=true)
- 一条数据中除了数据表的字段外，还有许多其它的字段（图中未全部写出来）
- 每条数据通过单向链表连接（图中未画出）
- 数据按照主键排序（按非主键建立的索引，按索引字段排序）
- 最小记录和最大记录是伪数据；最小记录的`next_record`指向真实数据中主键最小的数据；主键最大值的真实数据的`next_record`指向最大记录；
- 数据分为多个组，其中最小记录所在分组规定只有1条数据，就是最小记录本身；最大记录所在组包含数据范围为1~8条；其余组数据范围为4~8条；
- **槽很关键**，每个组都有一个槽，槽是连续的存储空间，暂且理解为数组吧，槽中记录的是与之对应的组中的最大主键值和该主键对应数据的地址偏移量，也就是说，槽直接指向组内主键最大的数据；
- mysql的主键查找逻辑：
*使用**二分法**在槽中找出对应的组，比如槽2的值为8，槽1的值为4，如果找主键为6的值，因为`6<8`，`6>4`可以确定主键为6的值肯定在槽2对应的组中，然后根据槽1指向主键为4的记录，该记录又指向了槽2的第一条记录（即主键为5的记录），然后从5开始根据链表遍历就能找到主键为6的数据了*

### 数据删除
**数据删除后，底层记录并不会删除**，但会做以下改变：
- 每条数据中有一个`delete_mask`，为0表示数据未被删除，为1表示已删除，所以数据删除后该字段会置为1；
- 该数据的上一条数据会指向它的下一条数据（类比链表的节点删除），该数据会指向它的下一条被删的数据，构成垃圾链表；
- 每条数据有一个字段记录组内包含的数据数，也要跟着改变；
- 槽如果需要变化也会跟着变化
- 被删除的记录虽然不会删除，但是后续有新纪录插入进来，可能会覆盖掉垃圾记录